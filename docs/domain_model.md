# Voice Agent Platform – Domain Model

This document captures the core data structures and API surface derived from `platformdesc.md`. It is the reference for backend persistence and service contracts.

## Entities

| Entity | Purpose |
| --- | --- |
| `organization` | Tenant boundary for customer accounts. Owns workflows, phone numbers, analytics. |
| `workflow` | Versioned configuration graph of agent nodes, paths, and tooling. |
| `workflow_version` | Immutable snapshot of a workflow (for deployment and rollback). |
| `agent_node` | Configurable agent definition (instructions, tools, paths). |
| `agent_tool` | Tool binding available to an agent. |
| `agent_path` | Directional transfer definition between agents. |
| `path_variable` | Metadata describing required variables for a path. |
| `workspace_variable` | Global variables that span the workflow (e.g., shared secrets or environment config). |
| `test_session` | Simulated chat/voice test logs. |
| `call_session` | Production runtime session. |
| `session_event` | Analytics events: active agent transitions, tool executions, variable collection. |

## Supabase Schema (SQL)

```sql
-- Organizations
create table if not exists organization (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- Workflows and versioning
create table if not exists workflow (
  id uuid primary key default gen_random_uuid(),
  organization_id uuid references organization(id) on delete cascade,
  name text not null,
  description text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table if not exists workflow_version (
  id uuid primary key default gen_random_uuid(),
  workflow_id uuid references workflow(id) on delete cascade,
  version integer not null,
  status text check (status in ('draft','published','archived')) default 'draft',
  published_at timestamptz,
  config jsonb not null,
  created_at timestamptz default now(),
  unique (workflow_id, version)
);

-- Agents
create table if not exists agent_node (
  id uuid primary key default gen_random_uuid(),
  workflow_version_id uuid references workflow_version(id) on delete cascade,
  name text not null,
  instructions text not null,
  stt_config jsonb,
  llm_config jsonb,
  tts_config jsonb,
  vad_config jsonb,
  metadata jsonb,
  position jsonb,
  created_at timestamptz default now()
);

create table if not exists agent_tool (
  id uuid primary key default gen_random_uuid(),
  agent_id uuid references agent_node(id) on delete cascade,
  tool_type text not null,
  config jsonb not null,
  display_name text,
  created_at timestamptz default now()
);

create table if not exists agent_path (
  id uuid primary key default gen_random_uuid(),
  from_agent_id uuid references agent_node(id) on delete cascade,
  to_agent_id uuid references agent_node(id) on delete cascade,
  name text not null,
  description text,
  guard_condition text,
  metadata jsonb,
  created_at timestamptz default now()
);

create table if not exists path_variable (
  id uuid primary key default gen_random_uuid(),
  path_id uuid references agent_path(id) on delete cascade,
  name text not null,
  description text,
  is_required boolean default true,
  data_type text default 'string',
  created_at timestamptz default now()
);

-- Runtime tracking
create table if not exists call_session (
  id uuid primary key default gen_random_uuid(),
  workflow_version_id uuid references workflow_version(id),
  external_session_id text,
  started_at timestamptz default now(),
  ended_at timestamptz,
  status text check (status in ('active','completed','dropped')),
  channel text default 'voice'
);

create table if not exists session_event (
  id bigint generated by default as identity primary key,
  session_id uuid references call_session(id) on delete cascade,
  event_type text not null,
  payload jsonb not null,
  occurred_at timestamptz default now()
);

create table if not exists test_session (
  id uuid primary key default gen_random_uuid(),
  workflow_version_id uuid references workflow_version(id),
  transcript jsonb,
  created_at timestamptz default now()
);
```

## API Surface (FastAPI)

| Endpoint | Method | Description |
| --- | --- | --- |
| `/api/workflows` | GET | List workflows for organization |
| `/api/workflows` | POST | Create workflow (name, description) |
| `/api/workflows/{workflow_id}` | GET | Fetch workflow details with latest draft version |
| `/api/workflows/{workflow_id}` | PATCH | Update workflow metadata |
| `/api/workflows/{workflow_id}/versions` | POST | Create draft version copy |
| `/api/workflow-versions/{version_id}` | GET | Retrieve full configuration (agents, paths, tools) |
| `/api/workflow-versions/{version_id}` | PATCH | Update configuration payload |
| `/api/workflow-versions/{version_id}/publish` | POST | Mark version as published |
| `/api/workflow-versions/{version_id}/test/chat` | POST | Run chat-based simulation |
| `/api/workflow-versions/{version_id}/test/voice` | POST | Initiate voice test session |
| `/api/workflow-versions/{version_id}/analytics` | GET | Return aggregated analytics for paths/tools |

### Configuration Payload Shape

```json
{
  "agents": [
    {
      "id": "uuid",
      "name": "Intake",
      "instructions": "Collect customer intent...",
      "llm": {"provider": "openai", "model": "gpt-4o-mini"},
      "stt": {"provider": "assemblyai", "model": "universal-streaming"},
      "tts": {"provider": "cartesia", "voice_id": "sonic-2"},
      "tools": [
        {"tool_type": "check_order", "config": {...}}
      ],
      "paths": [
        {
          "id": "uuid",
          "name": "To Billing",
          "description": "Use when customer mentions invoices",
          "target_agent_id": "uuid",
          "required_variables": [
            {"name": "customer_id", "is_required": true}
          ]
        }
      ]
    }
  ]
}
```

## Runtime Responsibilities

1. **Workflow Loader** – Pulls `workflow_version.config`, instantiates LiveKit agents according to definitions.
2. **Session Manager** – Persists session start/end, tracks active agent, logs events.
3. **Tool Adapter** – Maps configured tools to executable Python coroutines with access to Supabase or external APIs.
4. **Testing Harness** – Simulates chat/voice interactions leveraging LiveKit agent sessions without external telephony.

## Open Questions

- Authentication/authorization strategy for multi-tenant access (Supabase Row Level Security expected).
- Tool library extensibility (static list vs. dynamic plugin loading).
- Version migration strategy when configuration schema evolves.

